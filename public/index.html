<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebRTC Tailwind Call</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 flex flex-col items-center min-h-screen p-4">
    <h1 class="text-2xl font-bold mb-2">WebRTC Video Call</h1>
    <p class="mb-4">Share this link with a friend:</p>
    <div id="link" class="text-blue-600 font-medium mb-4"></div>

    <div class="flex gap-4 mb-4" id="videos">
      <video
        id="local"
        autoplay
        muted
        class="w-80 h-60 bg-black rounded-lg shadow-md"
      ></video>
      <video
        id="remote"
        autoplay
        class="w-80 h-60 bg-black rounded-lg shadow-md"
      ></video>
    </div>

    <div class="flex gap-2 mb-4" id="controls">
      <button
        id="btnToggleAudio"
        class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
      >
        Mute
      </button>
      <button
        id="btnToggleVideo"
        class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
      >
        Disable Video
      </button>
      <button
        id="btnEnd"
        class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600"
      >
        End Call
      </button>
    </div>

    <div
      id="incoming"
      class="fixed top-1/4 left-1/2 transform -translate-x-1/2 bg-white p-6 rounded shadow-lg hidden"
    >
      <h2 class="text-lg font-bold mb-2">Incoming Call</h2>
      <p class="mb-4">Someone is calling you. Accept to start.</p>
      <div class="flex gap-2">
        <button
          id="acceptBtn"
          class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"
        >
          Accept
        </button>
        <button
          id="declineBtn"
          class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600"
        >
          Decline
        </button>
      </div>
    </div>

    <script type="module">
      const urlParams = new URLSearchParams(location.search);
      let room = urlParams.get("room");
      if (!room) {
        room = Math.random().toString(36).slice(2, 9);
        history.replaceState(null, "", "?room=" + room);
      }
      document.getElementById("link").innerText = location.href;

      const localVideo = document.getElementById("local");
      const remoteVideo = document.getElementById("remote");
      const btnToggleAudio = document.getElementById("btnToggleAudio");
      const btnToggleVideo = document.getElementById("btnToggleVideo");
      const btnEnd = document.getElementById("btnEnd");
      const incomingBox = document.getElementById("incoming");
      const acceptBtn = document.getElementById("acceptBtn");
      const declineBtn = document.getElementById("declineBtn");

      const pcConfig = {
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
      };
      let pc, localStream, ws, role;

      function createPeerConnection() {
        pc = new RTCPeerConnection(pcConfig);
        localStream.getTracks().forEach((t) => pc.addTrack(t, localStream));
        pc.ontrack = (e) => {
          remoteVideo.srcObject = e.streams[0];
        };
        pc.onicecandidate = (e) => {
          if (e.candidate)
            ws.send(
              JSON.stringify({ type: "ice", room, payload: e.candidate })
            );
        };
        pc.onconnectionstatechange = () => {
          if (["disconnected", "failed", "closed"].includes(pc.connectionState))
            endCallUI();
        };
      }

      async function startLocalMedia() {
        if (localStream) return;
        localStream = await navigator.mediaDevices.getUserMedia({
          audio: true,
          video: true,
        });
        localVideo.srcObject = localStream;
      }

      async function init() {
        ws = new WebSocket(
          (location.protocol === "https:" ? "wss" : "ws") +
            "://" +
            location.host
        );
        ws.onopen = () => ws.send(JSON.stringify({ type: "join", room }));
        ws.onmessage = async (ev) => {
          let msg = JSON.parse(ev.data);
          if (msg.type === "joined") {
            role = msg.role;
            console.log("joined as", role);
          }
          if (msg.type === "peer-joined") {
            console.log("peer joined â€” waiting for callee to accept");
          }
          if (msg.type === "incoming") {
            incomingBox.classList.remove("hidden");
          }
          if (msg.type === "callee-accepted") {
            await startLocalMedia();
            createPeerConnection();
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            ws.send(JSON.stringify({ type: "offer", room, payload: offer }));
          }
          if (msg.type === "offer") {
            await startLocalMedia();
            createPeerConnection();
            await pc.setRemoteDescription(
              new RTCSessionDescription(msg.payload)
            );
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify({ type: "answer", room, payload: answer }));
          }
          if (msg.type === "answer") {
            await pc.setRemoteDescription(
              new RTCSessionDescription(msg.payload)
            );
          }
          if (msg.type === "ice") {
            try {
              await pc.addIceCandidate(msg.payload);
            } catch {}
          }
          if (["end", "peer-left"].includes(msg.type)) endCallUI();
          if (msg.type === "full") alert("Room full (max 2)");
        };
        ws.onclose = () => console.log("ws closed");
      }

      acceptBtn.onclick = () => {
        incomingBox.classList.add("hidden");
        ws.send(JSON.stringify({ type: "accept", room }));
      };
      declineBtn.onclick = () => {
        incomingBox.classList.add("hidden");
        ws.send(JSON.stringify({ type: "end", room }));
      };
      btnToggleAudio.onclick = () => {
        const track = localStream?.getAudioTracks()[0];
        if (track) {
          track.enabled = !track.enabled;
          btnToggleAudio.innerText = track.enabled ? "Mute" : "Unmute";
        }
      };
      btnToggleVideo.onclick = () => {
        const track = localStream?.getVideoTracks()[0];
        if (track) {
          track.enabled = !track.enabled;
          btnToggleVideo.innerText = track.enabled
            ? "Disable Video"
            : "Enable Video";
        }
      };
      btnEnd.onclick = () => {
        ws.send(JSON.stringify({ type: "end", room }));
        cleanup();
      };

      function endCallUI() {
        cleanup();
        alert("Call ended");
      }
      function cleanup() {
        if (pc) {
          try {
            pc.close();
          } catch {}
          pc = null;
        }
        if (localStream) {
          localStream.getTracks().forEach((t) => t.stop());
          localStream = null;
        }
        localVideo.srcObject = null;
        remoteVideo.srcObject = null;
        try {
          ws.close();
        } catch {}
      }

      init();
    </script>
  </body>
</html>
