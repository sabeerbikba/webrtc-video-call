<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>WhatsApp Style WebRTC Call</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-900 text-white flex flex-col h-screen">
    <!-- Pre-call Screen -->
    <div
      id="preCall"
      class="flex flex-col flex-1 items-center justify-center space-y-6"
    >
      <h1 class="text-2xl font-bold text-green-500">WhatsApp Video Call</h1>

      <!-- Create Room -->
      <button id="btnCreate" class="px-6 py-2 bg-green-600 rounded-lg">
        Create Room
      </button>

      <!-- Join Room -->
      <div class="flex space-x-2">
        <input
          id="roomInput"
          type="text"
          placeholder="Enter Room ID"
          class="px-3 py-2 rounded-lg text-black"
        />
        <button id="btnJoin" class="px-4 py-2 bg-green-600 rounded-lg">
          Join
        </button>
      </div>

      <!-- Share link -->
      <p id="shareInfo" class="text-sm text-gray-400"></p>
    </div>

    <!-- Call Screen -->
    <div id="callScreen" class="hidden flex flex-col flex-1">
      <!-- Status Bar -->
      <div id="status" class="p-2 bg-green-700 text-sm text-center">
        Connecting…
      </div>

      <!-- Video Container -->
      <div class="relative flex-1 bg-black overflow-hidden">
        <video
          id="mainVideo"
          autoplay
          playsinline
          class="w-full h-full object-contain bg-black"
        ></video>
        <video
          id="pipVideo"
          autoplay
          playsinline
          muted
          class="absolute bottom-2 right-2 w-28 h-28 sm:w-40 sm:h-40 border-2 border-white rounded-lg shadow-lg cursor-pointer"
        ></video>
      </div>

      <!-- Controls -->
      <div class="flex justify-around bg-gray-800 p-3">
        <button id="btnMute" class="px-4 py-2 bg-green-600 rounded-full">
          Mute
        </button>
        <button id="btnVideo" class="px-4 py-2 bg-green-600 rounded-full">
          Video Off
        </button>
        <button id="btnSwitch" class="px-4 py-2 bg-green-600 rounded-full">
          Switch Cam
        </button>
        <button id="btnEnd" class="px-4 py-2 bg-red-600 rounded-full">
          End
        </button>
      </div>
    </div>

    <!-- Incoming Popup -->
    <div
      id="incoming"
      class="hidden absolute inset-0 bg-black bg-opacity-80 flex items-center justify-center"
    >
      <div class="bg-gray-800 p-6 rounded-lg text-center space-y-4">
        <p class="text-lg font-semibold">Incoming Call</p>
        <div class="space-x-4">
          <button id="btnAccept" class="px-4 py-2 bg-green-600 rounded-lg">
            Accept
          </button>
          <button id="btnReject" class="px-4 py-2 bg-red-600 rounded-lg">
            Reject
          </button>
        </div>
      </div>
    </div>

    <script>
      const preCall = document.getElementById("preCall");
      const callScreen = document.getElementById("callScreen");
      const shareInfo = document.getElementById("shareInfo");
      const statusEl = document.getElementById("status");
      const mainVideo = document.getElementById("mainVideo");
      const pipVideo = document.getElementById("pipVideo");
      const incomingPopup = document.getElementById("incoming");

      // Buttons
      const btnCreate = document.getElementById("btnCreate");
      const btnJoin = document.getElementById("btnJoin");
      const btnAccept = document.getElementById("btnAccept");
      const btnReject = document.getElementById("btnReject");
      const btnMute = document.getElementById("btnMute");
      const btnVideo = document.getElementById("btnVideo");
      const btnSwitch = document.getElementById("btnSwitch");
      const btnEnd = document.getElementById("btnEnd");
      const roomInput = document.getElementById("roomInput");

      let ws,
        pc,
        localStream,
        remoteStream,
        currentCam = "user",
        room;

      function setStatus(msg) {
        statusEl.textContent = msg;
      }

      // Auto-detect ?room= in URL
      const urlParams = new URLSearchParams(window.location.search);
      const autoRoom = urlParams.get("room");
      const autoJoin = urlParams.get("auto");
      if (autoRoom) {
        roomInput.value = autoRoom;
        if (autoJoin === "1") {
          startCallFlow(autoRoom);
        }
      }

      // Create room
      btnCreate.onclick = () => {
        room = Math.random().toString(36).slice(2, 8);
        const link = `${location.origin}${location.pathname}?room=${room}&auto=1`;
        shareInfo.innerHTML = `
          Room created: <b>${room}</b><br>
          Share this link: <a href="${link}" class="text-green-400 underline">${link}</a>
        `;
        if (navigator.share) {
          navigator
            .share({
              title: "Join my video call",
              text: `Click to join room: ${room}`,
              url: link,
            })
            .catch(() => {});
        }
      };

      // Join room
      btnJoin.onclick = () => {
        room = roomInput.value.trim();
        if (!room) return alert("Enter room ID");
        window.location.href = `${location.pathname}?room=${room}&auto=1`;
      };

      // Incoming call popup
      btnAccept.onclick = () => {
        incomingPopup.classList.add("hidden");
        ws.send(JSON.stringify({ type: "accept", room }));
        startPeer(false);
      };
      btnReject.onclick = () => {
        incomingPopup.classList.add("hidden");
        ws.send(JSON.stringify({ type: "reject", room }));
        cleanup();
      };

      // Swap videos on tap
      pipVideo.onclick = () => {
        const tempSrc = mainVideo.srcObject;
        mainVideo.srcObject = pipVideo.srcObject;
        pipVideo.srcObject = tempSrc;
      };

      // Start call flow
      function startCallFlow(r) {
        room = r;
        preCall.classList.add("hidden");
        callScreen.classList.remove("hidden");
        ws = new WebSocket(
          (location.protocol === "https:" ? "wss://" : "ws://") + location.host
        );
        ws.onopen = () => ws.send(JSON.stringify({ type: "join", room }));
        ws.onmessage = async ({ data }) => {
          const msg = JSON.parse(data);
          if (msg.type === "role") setStatus(`Role: ${msg.role}`);
          if (msg.type === "incoming") incomingPopup.classList.remove("hidden");
          if (msg.type === "peer-joined") setStatus("Peer joined");
          if (msg.type === "accepted") {
            setStatus("Call accepted, setting up…");
            startPeer(true);
          }
          if (msg.type === "rejected") {
            setStatus("Call rejected");
            cleanup();
          }
          if (msg.type === "offer") {
            setStatus("Offer received…");
            if (!pc) startPeer(false);
            await pc.setRemoteDescription(new RTCSessionDescription(msg.offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify({ type: "answer", answer, room }));
          }
          if (msg.type === "answer") {
            setStatus("Answer received, connecting…");
            await pc.setRemoteDescription(
              new RTCSessionDescription(msg.answer)
            );
          }
          if (msg.type === "candidate") {
            try {
              await pc.addIceCandidate(msg.candidate);
            } catch {}
          }
          if (msg.type === "end") {
            setStatus("Call ended");
            endAndGoHome();
          }
        };
      }

      // Peer setup
      async function startPeer(isInitiator) {
        pc = new RTCPeerConnection({
          iceServers: [
            { urls: "stun:stun.l.google.com:19302" },
            {
              urls: "turn:openrelay.metered.ca:80",
              username: "openrelayproject",
              credential: "openrelayproject",
            },
          ],
        });
        localStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: currentCam },
          audio: true,
        });
        pipVideo.srcObject = localStream;

        localStream
          .getTracks()
          .forEach((track) => pc.addTrack(track, localStream));

        pc.ontrack = (e) => {
          remoteStream = e.streams[0];
          mainVideo.srcObject = remoteStream;
        };

        pc.onicecandidate = (e) =>
          e.candidate &&
          ws.send(
            JSON.stringify({ type: "candidate", candidate: e.candidate, room })
          );

        if (isInitiator) {
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);
          ws.send(JSON.stringify({ type: "offer", offer, room }));
        }
      }

      // Controls
      btnMute.onclick = () => {
        if (!localStream) return;
        const t = localStream.getAudioTracks()[0];
        t.enabled = !t.enabled;
        btnMute.textContent = t.enabled ? "Mute" : "Unmute";
      };

      btnVideo.onclick = () => {
        if (!localStream) return;
        const t = localStream.getVideoTracks()[0];
        t.enabled = !t.enabled;
        btnVideo.textContent = t.enabled ? "Video Off" : "Video On";
      };

      // FIX: switch camera with replaceTrack()
      btnSwitch.onclick = async () => {
        currentCam = currentCam === "user" ? "environment" : "user";

        const newStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: currentCam },
          audio: true,
        });

        const newVideoTrack = newStream.getVideoTracks()[0];
        const sender = pc
          .getSenders()
          .find((s) => s.track && s.track.kind === "video");
        if (sender) {
          await sender.replaceTrack(newVideoTrack);
        }

        localStream.getTracks().forEach((t) => t.stop());
        localStream = newStream;
        pipVideo.srcObject = localStream;
      };

      btnEnd.onclick = () => {
        ws.send(JSON.stringify({ type: "end", room }));
        endAndGoHome();
      };

      // Cleanup + redirect
      function cleanup() {
        if (pc) {
          try {
            pc.close();
          } catch {}
          pc = null;
        }
        if (localStream) {
          localStream.getTracks().forEach((t) => t.stop());
        }
        mainVideo.srcObject = null;
        pipVideo.srcObject = null;
      }
      function endAndGoHome() {
        cleanup();
        window.location.href = "/";
      }

      // Hide switch button if device only has one camera
      async function checkCameraCount() {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoInputs = devices.filter((d) => d.kind === "videoinput");
        if (videoInputs.length < 2) {
          btnSwitch.classList.add("hidden");
        }
      }
      checkCameraCount();
    </script>
  </body>
</html>
